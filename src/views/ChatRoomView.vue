<template>
        <div class="page-container">
                <AppHeader :title="isTyping ? 'Ê≠£Âú®ËæìÂÖ•‰∏≠‚Ä¶' : (actor?.name || 'ËÅäÂ§©')" :override-back-action="goBack">
                        <template #subtitle>
                                <div class="status-indicator" v-if="actor">
                                        <div class="status-dot" :style="{ 
                                                        backgroundColor: actor?.status?.color || '#4CAF50',
                                                        '--status-color': `${actor?.status?.color || '#4CAF50'}66`
                                                }">
                                        </div>
                                        <span class="status-text">{{ actor?.status?.text || 'Âú®Á∫ø' }}</span>
                                </div>
                        </template>
                        <template #right>
                                <button class="header-action-button" @click="goToProfile">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                stroke-width="1.5" stroke="currentColor" width="24" height="24">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                </button>
                        </template>
                </AppHeader>

                <main v-if="actor" class="chat-content content" @click="handleContentClick">
                        <!-- Ê∂àÊÅØÂàóË°® -->
                        <div class="messages-container" :class="{ 'sticker-panel-open': showStickerPanel }"
                                ref="messagesContainer" @scroll="handleScroll">
                                <div v-if="isLoadingMore" class="loading-indicator">
                                        <p>Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ...</p>
                                </div>
                                <div v-for="message in displayedMessages" :key="message.id" class="message-item"
                                        :class="{ 'own-message': message.actorId === userActorId }">
                                        <!-- ÂØπÊñπÂ§¥ÂÉè -->
                                        <div class="message-avatar" v-if="message.actorId !== userActorId">
                                                <img v-if="actor?.avatar" :src="actor.avatar" :alt="actor.name">
                                                <span v-else class="avatar-initial">{{ actor?.name?.[0] || '#' }}</span>
                                        </div>

                                        <!-- Áî®Êà∑Â§¥ÂÉè -->
                                        <div class="message-avatar" v-else>
                                                <img v-if="currentUserPersona?.avatar" :src="currentUserPersona.avatar"
                                                        :alt="currentUserPersona?.name || 'User'">
                                                <span v-else class="avatar-initial">{{
                                                        getInitial(currentUserPersona?.name || 'User') }}</span>
                                        </div>
                                        <div class="message-content">
                                                <!-- ÊñáÂ≠óÊ∂àÊÅØ -->
                                                <div v-if="!message.content.type || message.content.type === 'text'"
                                                        class="message-bubble">
                                                        <p>{{ message.content.content }}</p>
                                                        <div v-if="message.content.action" class="message-action">
                                                                <em>*{{ message.content.action }}*</em>
                                                        </div>
                                                </div>

                                                <!-- Ë°®ÊÉÖÂåÖÊ∂àÊÅØ -->
                                                <div v-else-if="message.content.type === 'sticker'"
                                                        class="sticker-message">
                                                        <img :src="message.content.url"
                                                                :alt="message.content.name || 'Ë°®ÊÉÖÂåÖ'"
                                                                class="sticker-image" />
                                                </div>

                                                <!-- ÂõæÁâáÊ∂àÊÅØ -->
                                                <div v-else-if="message.content.type === 'image'" class="image-message">
                                                        <!-- ÊñáÂ≠óÂõæÁâá -->
                                                        <div v-if="message.content.subtype === 'text'"
                                                                class="text-image-placeholder">
                                                                <div class="text-image-icon">üñºÔ∏è</div>
                                                                <div class="text-image-description">{{
                                                                        message.content.description }}</div>
                                                        </div>
                                                        <!-- ÁúüÂÆûÂõæÁâá -->
                                                        <img v-else :src="message.content.url"
                                                                :alt="message.content.fileName || 'ÂõæÁâá'"
                                                                class="real-image" @load="scrollToBottom" />
                                                </div>

                                                <!-- ÊîØ‰ªòÊ∂àÊÅØ -->
                                                <div v-else-if="message.content.type === 'payment'"
                                                        class="payment-message">
                                                        <div class="payment-header">
                                                                <span class="payment-icon">
                                                                        {{ message.content.subtype === 'transfer' ? 'üí∏'
                                                                        : 'üí≥' }}
                                                                </span>
                                                                <span class="payment-type">
                                                                        {{ message.content.subtype === 'transfer' ? 'ËΩ¨Ë¥¶'
                                                                        : '‰ª£‰ªò' }}
                                                                </span>
                                                        </div>
                                                        <div class="payment-amount">¬•{{
                                                                message.content.amount.toFixed(2) }}</div>
                                                        <div v-if="message.content.productInfo" class="payment-product">
                                                                ÂïÜÂìÅÔºö{{ message.content.productInfo }}
                                                        </div>
                                                        <div v-if="message.content.message" class="payment-note">
                                                                {{ message.content.message }}
                                                        </div>
                                                </div>

                                                <div class="message-time">
                                                        {{ formatTimestamp(message.timestamp, true) }}
                                                </div>
                                        </div>
                                </div>

                                <!-- AIÊ≠£Âú®ËæìÂÖ•ÁöÑÊ∂àÊÅØÔºàÂåÖÂê´ÊÄùËÄÉÂíåÊâìÂ≠óÁä∂ÊÄÅÔºâ -->
                                <div v-if="isTyping || isGenerating" class="message-item">
                                        <div class="message-avatar">
                                                <img v-if="actor?.avatar" :src="actor.avatar" :alt="actor.name">
                                                <span v-else class="avatar-initial">{{ actor?.name?.[0] || '#' }}</span>
                                        </div>
                                        <div class="message-content">
                                                <div class="message-bubble typing-bubble">
                                                        <!-- Â¶ÇÊûúÊ≠£Âú®ÊâìÂ≠ó‰∏îÊúâÂÜÖÂÆπÔºåÊòæÁ§∫ÊâìÂ≠óÂÜÖÂÆπ -->
                                                        <p v-if="isTyping && typingMessage">{{ typingMessage }}</p>
                                                        <!-- Âê¶ÂàôÊòæÁ§∫ÊÄùËÄÉ/ÊâìÂ≠óÊåáÁ§∫Âô® -->
                                                        <div v-else class="typing-indicator">
                                                                <CirclesToRhombusesSpinner :animation-duration="1200"
                                                                        :circles-num="3" :circle-size="1"
                                                                        color="var(--char-bubble-text)" />
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                        </div>
                </main>

                <div v-else class="loading-state">
                        <p>Ê≠£Âú®Âä†ËΩΩ...</p>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="input-area" :class="{ 'keyboard-visible': isKeyboardVisible }" v-if="actor">
                        <div class="input-container" @click.stop>
                                <!-- ÂäüËÉΩÊåâÈíÆË°å -->
                                <div class="function-buttons">
                                        <button class="function-btn" :class="{ active: showStickerPanel }"
                                                @click.stop="toggleStickerPanel" title="Ë°®ÊÉÖÂåÖ">
                                                <svg xmlns="http://www.w3.org/2000/svg" height="24"
                                                        viewBox="0 -960 960 960" width="24" fill="currentColor">
                                                        <path
                                                                d="M260-280q-26 0-43-17t-17-43q0-25 17-42.5t43-17.5q25 0 42.5 17.5T320-340q0 26-17.5 43T260-280Zm0-280q-26 0-43-17t-17-43q0-25 17-42.5t43-17.5q25 0 42.5 17.5T320-620q0 26-17.5 43T260-560Zm140 120v-80h160v80H400Zm288 200-66-44q28-43 43-92.5T680-480q0-66-21.5-124T598-709l61-51q48 57 74.5 128.5T760-480q0 67-19 127.5T688-240Z" />
                                                </svg>
                                        </button>
                                        <button class="function-btn" @click.stop="handleSendImage" title="ÂèëÈÄÅÂõæÁâá">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                                        stroke="currentColor" class="size-6">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                                d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                                                </svg>

                                        </button>
                                        <button class="function-btn" title="ËØ≠Èü≥">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
                                                        <path
                                                                d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5" />
                                                        <path
                                                                d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3" />
                                                </svg>
                                        </button>
                                        <button class="function-btn" @click.stop="handlePayment" title="ËΩ¨Ë¥¶">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35"
                                                        fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                                        stroke="currentColor" class="size-6">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                                d="m9 7.5 3 4.5m0 0 3-4.5M12 12v5.25M15 12H9m6 3H9m12-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                                </svg>
                                        </button>
                                        <button class="function-btn" title="Âê¨Ê≠å">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        fill="currentColor" class="bi bi-music-note"
                                                        viewBox="0 0 16 16">
                                                        <path
                                                                d="M9 13c0 1.105-1.12 2-2.5 2S4 14.105 4 13s1.12-2 2.5-2 2.5.895 2.5 2" />
                                                        <path fill-rule="evenodd" d="M9 3v10H8V3z" />
                                                        <path
                                                                d="M8 2.82a1 1 0 0 1 .804-.98l3-.6A1 1 0 0 1 13 2.22V4L8 5z" />
                                                </svg>
                                        </button>
                                        <button class="function-btn" @click.stop="handleCall" title="ÈÄöËØù">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                                        stroke="currentColor" class="size-6">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                                d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
                                                </svg>

                                        </button>
                                        <button class="function-btn" title="‰∏ªÈ¢ò" @click="toggleThemeColor">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        fill="currentColor" class="bi bi-circle-half"
                                                        viewBox="0 0 16 16"
                                                        :style="isUsingUserBubbleTheme ? 'transform: scaleX(-1);' : ''">
                                                        <path
                                                                d="M8 15A7 7 0 1 0 8 1zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16" />
                                                </svg>
                                        </button>
                                </div>

                                <!-- ËæìÂÖ•ÂíåÂèëÈÄÅË°å -->
                                <div class="input-row">
                                        <textarea v-model="newMessage" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." class="message-input"
                                                rows="1" @keydown="handleKeydown" @focus="handleInputFocus"
                                                @blur="handleInputBlur" ref="messageInput"></textarea>
                                        <button class="action-button generate-btn" @click="generateReply"
                                                :disabled="isGenerating" title="ÁîüÊàêÂõûÂ§ç">
                                                <svg v-if="!isGenerating" xmlns="http://www.w3.org/2000/svg" width="24"
                                                        height="24" fill="currentColor" class="bi bi-stars"
                                                        viewBox="0 0 16 16">
                                                        <path
                                                                d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z" />
                                                </svg>
                                                <SpringSpinner v-else :animation-duration="3000" :size="20"
                                                        color="var(--accent-primary)" />
                                        </button>
                                        <button class="action-button send-btn" @click="sendMessage"
                                                :disabled="!newMessage.trim()" title="ÂèëÈÄÅ">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        fill="none" viewBox="0 0 24 24"
                                                        stroke-width="2" stroke="currentColor" class="size-6">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                                d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
                                                </svg>



                                        </button>
                                </div>
                        </div>


                </div>
                <!-- Ë°®ÊÉÖÂåÖÈù¢Êùø -->
                <transition name="sticker-panel">
                        <div v-if="showStickerPanel" class="sticker-panel" @click.stop>
                                <div v-if="stickers.length === 0" class="empty-stickers">
                                        <p>ËøòÊ≤°ÊúâË°®ÊÉÖÂåÖÔºå<router-link to="/stickers"
                                                        class="add-stickers-link">ÂéªÊ∑ªÂä†</router-link>‰∏Ä‰∫õÂêß„ÄÇ</p>
                                </div>
                                <div v-else class="sticker-grid">
                                        <div v-for="sticker in stickers" :key="sticker.id" class="sticker-item"
                                                @click="sendSticker(sticker)">
                                                <img :src="sticker.url" :alt="sticker.name" />
                                        </div>
                                </div>
                        </div>
                </transition>
        </div>
</template>

<script setup>
import { ref, computed, nextTick, onMounted, onUnmounted, watch } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useObservable } from '@vueuse/rxjs';
import { liveQuery } from 'dexie';
import { pinyin } from 'pinyin-pro';
import { CirclesToRhombusesSpinner, SpringSpinner } from 'epic-spinners';
import db from '../services/database.js';
import AppHeader from '../components/layout/Header.vue';
import { formatTimestamp } from '../utils/datetime.js';
import { generateAIReply } from '../services/aiChatAPIService.js';
import { getUserPersonaForGroup, getUserPersonaForUngrouped, getDefaultUserPersona } from '../services/userPersonaService.js';
import { USER_ACTOR_ID } from '../services/database.js';
import { getPersonalSettings, getTypingDelayConfig, getRandomMessageDelay } from '../services/personalSettingsService.js';
import { getActorBubbleStyle, applyBubbleStyles } from '../services/bubbleStyleService.js';
import { applyActorTheme, toggleActorTheme, restoreOriginalTheme, getActorThemeChoice } from '../services/themeService.js';
import { showActionChoiceModal, showPaymentModal, showUploadChoiceModal, promptForInput, showToast } from '../services/uiService.js';

const route = useRoute();
const router = useRouter();
const actorId = ref(route.params.id);
const newMessage = ref('');
const isGenerating = ref(false);
const isLoadingMore = ref(false);
const messagesContainer = ref(null);
const messageInput = ref(null);

// Áî®Êà∑IDÂ∏∏ÈáèÔºåÁî®‰∫éÊ®°Êùø
const userActorId = USER_ACTOR_ID;

// ÊáíÂä†ËΩΩÁõ∏ÂÖ≥Áä∂ÊÄÅ
const messageOffset = ref(0);
const messageLimit = 30;
const hasMoreMessages = ref(true);

// ÊâìÂ≠óÁâπÊïàÁõ∏ÂÖ≥Áä∂ÊÄÅ
const isTyping = ref(false);
const typingMessage = ref('');
const currentTypingIndex = ref(0);
const showStickerPanel = ref(false);
const stickers = ref([]);
// ËôöÊãüÈîÆÁõòÁä∂ÊÄÅ - ÁÆÄÂåñÂ§ÑÁêÜÔºå‰∏çÂÜç‰æùËµñÂ§çÊùÇÁöÑÊ£ÄÊµã
const isKeyboardVisible = ref(false);

// ‰∏™‰∫∫ËÆæÁΩÆ
const personalSettings = ref({
        typingSimulation: {
                enabled: true,
                speed: 5
        }
});

// ‰∏ªÈ¢òÁõ∏ÂÖ≥Áä∂ÊÄÅ
const currentBubbleStyle = ref(null);
// ‰ªélocalStorageËØªÂèñÁî®Êà∑ÂØπËøô‰∏™ËßíËâ≤ÁöÑ‰∏ªÈ¢òÈÄâÊã©
const isUsingUserBubbleTheme = ref(getActorThemeChoice(actorId.value));

// Ëé∑ÂèñËßíËâ≤‰ø°ÊÅØ
const actor = useObservable(
        liveQuery(() => db.actors.get(actorId.value)),
        { initialValue: null }
);

// Ëé∑ÂèñÂΩìÂâçËÅäÂ§©Â∫îÊòæÁ§∫ÁöÑÁî®Êà∑‰∫∫Ê†ºÔºà‰ªÖÁî®‰∫éÊòæÁ§∫Ôºâ
const currentUserPersona = useObservable(
        liveQuery(async () => {
                // Ëé∑ÂèñÂΩìÂâçËßíËâ≤‰ø°ÊÅØ
                const currentActor = await db.actors.get(actorId.value);
                if (!currentActor) {
                        console.log('ChatRoom: currentActor not found, using default persona');
                        return await getDefaultUserPersona();
                }
                
                // Ëé∑ÂèñËßíËâ≤ÁöÑÂàÜÁªÑID
                const groupId = currentActor.groupIds?.[0];
                console.log('ChatRoom: currentActor', currentActor.name, 'groupId:', groupId);
                
                if (groupId) {
                        // ÊúâÂàÜÁªÑÔºåËé∑ÂèñËØ•ÂàÜÁªÑÁªëÂÆöÁöÑÁî®Êà∑‰∫∫Ê†º
                        const groupPersona = await getUserPersonaForGroup(groupId);
                        console.log('ChatRoom: groupPersona for', groupId, ':', groupPersona);
                        if (groupPersona) return groupPersona;
                }
                
                // Ê≤°ÊúâÂàÜÁªÑÊàñÊ≤°ÊúâÁªëÂÆöÁöÑ‰∫∫Ê†ºÔºå‰ΩøÁî®ÈªòËÆ§‰∫∫Ê†º
                const defaultPersona = await getDefaultUserPersona();
                console.log('ChatRoom: using defaultPersona:', defaultPersona);
                return defaultPersona;
        }),
        { initialValue: null }
);

// Ëé∑ÂèñÊâÄÊúâÊ∂àÊÅØÔºàÁî®‰∫éÊáíÂä†ËΩΩÔºâ
const allMessages = useObservable(
        liveQuery(async () => {
                const allEvents = await db.events
                        .where('contextId').equals(actorId.value)
                        .and(event => event.type === 'privateMessage')
                        .toArray();
                return allEvents.sort((a, b) => a.timestamp - b.timestamp);
        }),
        { initialValue: [] }
);

// ÊòæÁ§∫ÁöÑÊ∂àÊÅØÔºàÊáíÂä†ËΩΩÂàáÁâáÔºâ
const displayedMessages = computed(() => {
        const total = allMessages.value.length;
        if (total === 0) return [];
        
        // ÊòæÁ§∫ÊúÄÊñ∞ÁöÑÊ∂àÊÅØÔºåÊ†πÊçÆoffsetÂÜ≥ÂÆöÊòæÁ§∫Â§öÂ∞ëÊù°ÂéÜÂè≤Ê∂àÊÅØ
        const messagesToShow = messageOffset.value + messageLimit;
        const startIndex = Math.max(0, total - messagesToShow);
        
        return allMessages.value.slice(startIndex);
});

// Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊ∂àÊÅØ
watch(allMessages, (newMessages) => {
        const total = newMessages.length;
        hasMoreMessages.value = total > displayedMessages.value.length;
        
        // ÂΩìÊúâÊñ∞Ê∂àÊÅØÊó∂ÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
        if (total > 0 && messageOffset.value === 0) {
                nextTick(() => scrollToBottom());
        }
}, { immediate: true });

// Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = () => {
        nextTick(() => {
                if (messagesContainer.value) {
                        messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight;
                }
        });
};

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñËá™Âä®ÊªöÂä®
watch(displayedMessages, () => {
        scrollToBottom();
}, { deep: true });

// ÁõëÂê¨AIÁä∂ÊÄÅÂèòÂåñÔºåÁ°Æ‰øùÁä∂ÊÄÅÊåáÁ§∫Âô®Âá∫Áé∞Êó∂ÊªöÂä®Âà∞Â∫ïÈÉ®
watch([isGenerating, isTyping], () => {
        nextTick(() => scrollToBottom());
}, { immediate: false });

// ÁõëÂê¨ÊâìÂ≠óÊ∂àÊÅØÂèòÂåñÔºåÁ°Æ‰øùÊâìÂ≠óËøáÁ®ã‰∏≠ÊåÅÁª≠ÊªöÂä®Âà∞Â∫ïÈÉ®
watch(typingMessage, () => {
        if (isTyping.value) {
                nextTick(() => scrollToBottom());
        }
}, { immediate: false });

// ÁõëÊéßÂΩìÂâçÁî®Êà∑‰∫∫Ê†ºÂèòÂåñÔºàË∞ÉËØïÁî®Ôºâ
watch(currentUserPersona, (newPersona, oldPersona) => {
        console.log('ChatRoom: currentUserPersona changed from', oldPersona, 'to', newPersona);
}, { immediate: true });

// Â§ÑÁêÜÊªöÂä®‰∫ã‰ª∂ÔºåÂÆûÁé∞ÊáíÂä†ËΩΩ
const handleScroll = async () => {
        if (!messagesContainer.value || isLoadingMore.value || !hasMoreMessages.value) return;
        
        const { scrollTop } = messagesContainer.value;
        
        // ÂΩìÁî®Êà∑ÊªöÂä®Âà∞È°∂ÈÉ®ÈôÑËøëÊó∂Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
        if (scrollTop <= 100) {
                isLoadingMore.value = true;
                
                // ‰øùÂ≠òÂΩìÂâçÊªöÂä®‰ΩçÁΩÆ
                const previousScrollHeight = messagesContainer.value.scrollHeight;
                
                // Ê®°ÊãüÂä†ËΩΩÂª∂Ëøü
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Â¢ûÂä†ÂÅèÁßªÈáè‰ª•Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
                messageOffset.value += messageLimit;
                
                // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
                await nextTick();
                const newScrollHeight = messagesContainer.value.scrollHeight;
                messagesContainer.value.scrollTop = newScrollHeight - previousScrollHeight;
                
                isLoadingMore.value = false;
        }
};

// Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
const adjustTextareaHeight = () => {
        if (messageInput.value) {
                messageInput.value.style.height = 'auto';
                messageInput.value.style.height = messageInput.value.scrollHeight + 'px';
        }
};

// Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
const handleKeydown = (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
        }
        // Ë∞ÉÊï¥È´òÂ∫¶
        nextTick(adjustTextareaHeight);
};

// Ë°®ÊÉÖÂåÖÈù¢ÊùøÁõ∏ÂÖ≥ÊñπÊ≥ï
const toggleStickerPanel = (event) => {
        // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°
        if (event) {
                event.stopPropagation();
        }
        
        showStickerPanel.value = !showStickerPanel.value;
        
        if (showStickerPanel.value) {
                // Ë°®ÊÉÖÈù¢ÊùøÊâìÂºÄÊó∂ÔºåÂÖ≥Èó≠ÈîÆÁõò
                if (messageInput.value) {
                        messageInput.value.blur();
                }
                // ÊªöÂä®Âà∞Â∫ïÈÉ®Á°Æ‰øùË°®ÊÉÖÈù¢ÊùøÂèØËßÅ
                nextTick(() => scrollToBottom());
        }
};

// ÁÇπÂáªÊ∂àÊÅØÂå∫ÂüüÊó∂ÂÖ≥Èó≠Ë°®ÊÉÖÈù¢Êùø
const handleContentClick = () => {
        if (showStickerPanel.value) {
                showStickerPanel.value = false;
        }
};

// ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÊó∂ÂÖ≥Èó≠Ë°®ÊÉÖÈù¢Êùø
const handleInputFocus = () => {
        // Ê†áËÆ∞ÈîÆÁõò‰∏∫ÂèØËßÅ
        isKeyboardVisible.value = true;
        
        // ÂÖ≥Èó≠Ë°®ÊÉÖÈù¢Êùø
        if (showStickerPanel.value) {
                showStickerPanel.value = false;
        }
        
        // Á°Æ‰øùËæìÂÖ•Ê°ÜÂèØËßÅ
        nextTick(() => scrollToBottom());
};

// ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπ
const handleInputBlur = () => {
        // Ê†áËÆ∞ÈîÆÁõò‰∏∫ÈöêËóè
        isKeyboardVisible.value = false;
};

const sendSticker = async (sticker) => {
        const message = {
                timestamp: Date.now(),
                actorId: USER_ACTOR_ID,
                contextId: actorId.value,
                type: 'privateMessage',
                content: {
                        type: 'sticker',
                        url: sticker.url,
                        name: sticker.name
                }
        };

        try {
                await db.events.add(message);
                await updateConversation(message);
                
                // ÂÖ≥Èó≠Ë°®ÊÉÖÂåÖÈù¢Êùø
                showStickerPanel.value = false;
                
                // Ëá™Âä®ÁîüÊàêAIÂõûÂ§ç
                setTimeout(() => {
                        generateReply();
                }, 500);
        } catch (error) {
                console.error('ÂèëÈÄÅË°®ÊÉÖÂåÖÂ§±Ë¥•:', error);
        }
};

// Âä†ËΩΩË°®ÊÉÖÂåÖÊï∞ÊçÆ
const loadStickers = async () => {
        try {
                const allStickers = await db.stickers.toArray();
                stickers.value = allStickers;
        } catch (error) {
                console.error('Âä†ËΩΩË°®ÊÉÖÂåÖÂ§±Ë¥•:', error);
        }
};

// ‰∏ªÈ¢òËâ≤ÂàáÊç¢ÂäüËÉΩ
const toggleThemeColor = () => {
        isUsingUserBubbleTheme.value = toggleActorTheme();
};

// Â§ÑÁêÜÂèëÈÄÅÂõæÁâá
const handleSendImage = async () => {
        const actions = [
                { key: 'text-image', label: 'ÊñáÂ≠óÂõæÁâá', iconType: 'text-image' },
                { key: 'upload-image', label: '‰∏ä‰º†ÂõæÁâá', iconType: 'upload-image' }
        ];
        
        const choice = await showActionChoiceModal('ÂèëÈÄÅÂõæÁâá', actions);
        if (!choice) return;
        
        if (choice === 'text-image') {
                const description = await promptForInput(
                        'ÊñáÂ≠óÂõæÁâáÊèèËø∞', 
                        'ËØ∑ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑÂõæÁâáÂÜÖÂÆπ', 
                        true, 
                        false
                );
                
                if (description) {
                        await sendTextImage(description);
                }
        } else if (choice === 'upload-image') {
                // ÊèêÁ§∫Áî®Êà∑ÂÖ≥‰∫éËßÜËßâÂäüËÉΩ
                showToast('ÊèêÁ§∫ÔºöÂ¶ÇÈúÄAIËØÜÂà´ÂõæÁâáÂÜÖÂÆπÔºåËØ∑Á°Æ‰øù‰ΩøÁî®ÊîØÊåÅËßÜËßâÂäüËÉΩÁöÑÊ®°Âûã', 'info');
                
                const uploadResult = await showUploadChoiceModal();
                if (uploadResult) {
                        if (uploadResult.type === 'local' && Array.isArray(uploadResult.value)) {
                                // Â§öÂº†ÂõæÁâá
                                for (const file of uploadResult.value) {
                                        await sendRealImage(file);
                                }
                        } else {
                                // ÂçïÂº†ÂõæÁâá
                                await sendRealImage(uploadResult.value);
                        }
                }
        }
};

// ÂèëÈÄÅÊñáÂ≠óÂõæÁâá
const sendTextImage = async (description) => {
        const message = {
                id: Date.now() + Math.random(),
                actorId: userActorId,
                contextId: actorId.value,
                type: 'privateMessage',
                content: {
                        type: 'image',
                        subtype: 'text',
                        description: description,
                        url: null
                },
                timestamp: Date.now()
        };

        try {
                await db.events.add(message);
                await updateConversation(message);
        } catch (error) {
                console.error('ÂèëÈÄÅÊñáÂ≠óÂõæÁâáÂ§±Ë¥•:', error);
                showToast('ÂèëÈÄÅÂ§±Ë¥•', 'error');
        }
};

// ÂèëÈÄÅÁúüÂÆûÂõæÁâá
const sendRealImage = async (imageData) => {
        const message = {
                id: Date.now() + Math.random(),
                actorId: userActorId,
                contextId: actorId.value,
                type: 'privateMessage',
                content: {
                        type: 'image',
                        subtype: 'real',
                        url: typeof imageData === 'string' ? imageData : URL.createObjectURL(imageData),
                        fileName: typeof imageData === 'string' ? null : imageData.name
                },
                timestamp: Date.now()
        };

        try {
                await db.events.add(message);
                await updateConversation(message);
        } catch (error) {
                console.error('ÂèëÈÄÅÂõæÁâáÂ§±Ë¥•:', error);
                showToast('ÂèëÈÄÅÂ§±Ë¥•', 'error');
        }
};

// Â§ÑÁêÜËΩ¨Ë¥¶
const handlePayment = async () => {
        const actions = [
                { key: 'transfer', label: 'ËΩ¨Ë¥¶', iconType: 'transfer' },
                { key: 'pay', label: '‰ª£‰ªò', iconType: 'pay' }
        ];
        
        const choice = await showActionChoiceModal('ÊîØ‰ªòÈÄâÈ°π', actions);
        if (!choice) return;
        
        const paymentData = await showPaymentModal(choice);
        if (paymentData) {
                await sendPaymentMessage(paymentData);
        }
};

// ÂèëÈÄÅÊîØ‰ªòÊ∂àÊÅØ
const sendPaymentMessage = async (paymentData) => {
        const message = {
                id: Date.now() + Math.random(),
                actorId: userActorId,
                contextId: actorId.value,
                type: 'privateMessage',
                content: {
                        type: 'payment',
                        subtype: paymentData.type,
                        amount: paymentData.amount,
                        message: paymentData.message,
                        productInfo: paymentData.productInfo
                },
                timestamp: Date.now()
        };

        try {
                await db.events.add(message);
                await updateConversation(message);
                showToast(`${paymentData.type === 'transfer' ? 'ËΩ¨Ë¥¶' : '‰ª£‰ªò'}ÂèëÈÄÅÊàêÂäü`, 'success');
        } catch (error) {
                console.error('ÂèëÈÄÅÊîØ‰ªòÊ∂àÊÅØÂ§±Ë¥•:', error);
                showToast('ÂèëÈÄÅÂ§±Ë¥•', 'error');
        }
};

// Â§ÑÁêÜÈÄöËØù
const handleCall = async () => {
        const actions = [
                { key: 'voice', label: 'ËØ≠Èü≥ÈÄöËØù', iconType: 'voice' },
                { key: 'video', label: 'ËßÜÈ¢ëÈÄöËØù', iconType: 'video' }
        ];
        
        const choice = await showActionChoiceModal('ÈÄöËØùÈÄâÈ°π', actions);
        if (choice) {
                showToast(`${choice === 'voice' ? 'ËØ≠Èü≥' : 'ËßÜÈ¢ë'}ÈÄöËØùÂäüËÉΩÊöÇÊú™ÂÆûÁé∞`, 'info');
        }
};

// Â§ÑÁêÜÊõ¥Â§öÂäüËÉΩÈÄâÈ°π
const handleMoreActions = async () => {
        const actions = [
                { key: 'red-packet', label: 'ÂèëÁ∫¢ÂåÖ', iconType: 'red-packet' },
                { key: 'sticker', label: 'Ë°®ÊÉÖÂåÖ', iconType: 'sticker' },
                { key: 'music', label: 'Èü≥‰πêÂàÜ‰∫´', iconType: 'music' },
                { key: 'location', label: '‰ΩçÁΩÆÂàÜ‰∫´', iconType: 'location' },
                { key: 'file', label: 'Êñá‰ª∂ÂàÜ‰∫´', iconType: 'file' },
                { key: 'gift', label: 'ÈÄÅÁ§ºÁâ©', iconType: 'gift' }
        ];
        
        const choice = await showActionChoiceModal('Êõ¥Â§öÂäüËÉΩ', actions);
        if (choice) {
                switch (choice) {
                        case 'red-packet':
                                showToast('Á∫¢ÂåÖÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
                                break;
                        case 'sticker':
                                showToast('Ë°®ÊÉÖÂåÖÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
                                break;
                        case 'music':
                                showToast('Èü≥‰πêÂàÜ‰∫´ÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
                                break;
                        case 'location':
                                showToast('‰ΩçÁΩÆÂàÜ‰∫´ÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
                                break;
                        case 'file':
                                showToast('Êñá‰ª∂ÂàÜ‰∫´ÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
                                break;
                        case 'gift':
                                showToast('Á§ºÁâ©ÂäüËÉΩÂºÄÂèë‰∏≠', 'info');
                                break;
                }
        }
};

// ÂèëÈÄÅÊ∂àÊÅØ
const sendMessage = async () => {
        if (!newMessage.value.trim()) return;

        const message = {
                timestamp: Date.now(),
                actorId: USER_ACTOR_ID,
                contextId: actorId.value,
                type: 'privateMessage',
                content: {
                        content: newMessage.value.trim()
                }
        };

        try {
                // ‰øùÂ≠òÊ∂àÊÅØÂà∞eventsË°®
                await db.events.add(message);
                
                // Êõ¥Êñ∞conversationË°®
                await updateConversation(message);
                
                newMessage.value = '';
                adjustTextareaHeight();

                // Ëá™Âä®ÁîüÊàêAIÂõûÂ§çÔºàÂª∂Ëøü‰∏ÄÁßíËÆ©Áî®Êà∑ÁúãÂà∞Ëá™Â∑±ÁöÑÊ∂àÊÅØÂÖàÂá∫Áé∞Ôºâ
                setTimeout(() => {
                        generateReply();
                }, 500);
        } catch (error) {
                console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
        }
};

// Ê®°ÊãüAIÂõûÂ§çÂáΩÊï∞ - Ê†πÊçÆËÆæÁΩÆ‰ΩøÁî®ÊâìÂ≠óÁâπÊïàÊàñÈöèÊú∫Âª∂Ëøü
const generateReply = async () => {
        if (isGenerating.value) return;
        
        isGenerating.value = true;
        
        try {
                // Ê®°ÊãüÊÄùËÄÉÊó∂Èó¥
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Ê®°ÊãüAIÂõûÂ§çÂÜÖÂÆπÔºàÂ§öÊù°Ê∂àÊÅØÔºâ
                const mockReplies = [
                        {
                                content: "‰Ω†Â•ΩÂëÄÔºÅÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔºÅ"
                        },
                        {
                                content: "‰ªäÂ§©Â§©Ê∞îÁúü‰∏çÈîôÔºåÂøÉÊÉÖ‰πüÂèòÂæóÂæàÊ£íÂë¢~"
                        },
                        {
                                content: "Êúâ‰ªÄ‰πàÊÉ≥ËÅäÁöÑÂêóÔºüÊàëÂæà‰πêÊÑèÈô™‰Ω†ËÅäÂ§©ÔºÅ"
                        }
                ];

                // Ê†πÊçÆËÆæÁΩÆÂÜ≥ÂÆö‰ΩøÁî®ÊâìÂ≠óÊ®°ÊãüËøòÊòØÈöèÊú∫Âª∂Ëøü
                if (personalSettings.value.typingSimulation.enabled) {
                        // ‰ΩøÁî®ÊãºÈü≥ÊâìÂ≠óÊ®°Êãü
                        for (let i = 0; i < mockReplies.length; i++) {
                                const reply = mockReplies[i];
                                
                                // ÂºÄÂßãÊâìÂ≠óÁä∂ÊÄÅÔºà‰ºöËá™Âä®ÈöêËóèÊÄùËÄÉÁä∂ÊÄÅÔºâ
                                isTyping.value = true;
                                
                                // ÊòæÁ§∫ÊãºÈü≥ÊâìÂ≠óÁâπÊïà
                                await simulatePinyinTyping(reply.content);
                                
                                // ‰øùÂ≠òÂÆåÊï¥Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
                                const messageEvent = {
                                        timestamp: Date.now(),
                                        actorId: actorId.value,
                                        contextId: actorId.value,
                                        type: 'privateMessage',
                                        content: {
                                                content: reply.content
                                        }
                                };

                                await db.events.add(messageEvent);
                                await updateConversation(messageEvent);
                                
                                // Ê∂àÊÅØÈó¥‰øùÊåÅËæìÂÖ•Áä∂ÊÄÅÔºåÂè™Ê∏ÖÁ©∫ÂΩìÂâçÊâìÂ≠óÂÜÖÂÆπÔºå‰∏çÊîπÂèòisTypingÁä∂ÊÄÅ
                                if (i < mockReplies.length - 1) {
                                        typingMessage.value = '';
                                        // ‰øùÊåÅisTyping‰∏∫trueÔºåÁ°Æ‰øùheaderÊåÅÁª≠ÊòæÁ§∫"Ê≠£Âú®ËæìÂÖ•‰∏≠"
                                        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                                }
                        }
                } else {
                        // ‰ΩøÁî®ÈöèÊú∫Âª∂ËøüÔºå‰∏çÊòæÁ§∫ÊâìÂ≠óËøáÁ®ã
                        for (let i = 0; i < mockReplies.length; i++) {
                                const reply = mockReplies[i];
                                
                                // ËÆ°ÁÆóÈöèÊú∫Âª∂ËøüÊó∂Èó¥
                                const delay = getRandomMessageDelay(reply.content.length);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                
                                // Áõ¥Êé•‰øùÂ≠òÂÆåÊï¥Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
                                const messageEvent = {
                                        timestamp: Date.now(),
                                        actorId: actorId.value,
                                        contextId: actorId.value,
                                        type: 'privateMessage',
                                        content: {
                                                content: reply.content
                                        }
                                };

                                await db.events.add(messageEvent);
                                await updateConversation(messageEvent);
                                
                                // Ê∂àÊÅØÈó¥Ê∑ªÂä†È¢ùÂ§ñÁöÑÈöèÊú∫Èó¥Èöî
                                if (i < mockReplies.length - 1) {
                                        const betweenDelay = Math.random() * 1000 + 500; // 0.5-1.5ÁßíÈöèÊú∫Èó¥Èöî
                                        await new Promise(resolve => setTimeout(resolve, betweenDelay));
                                }
                        }
                }
                
        } catch (error) {
                console.error('ÁîüÊàêÂõûÂ§çÂ§±Ë¥•:', error);
                
                // ÂºÄÂßãÊâìÂ≠óÁä∂ÊÄÅÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                isTyping.value = true;
                
                // Ê∑ªÂä†ÈîôËØØÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
                const errorText = `Êä±Ê≠âÔºåÂá∫Áé∞‰∫ÜÈîôËØØÔºö${error.message}`;
                await simulatePinyinTyping(errorText);
                
                const errorMessage = {
                        timestamp: Date.now(),
                        actorId: actorId.value,
                        contextId: actorId.value,
                        type: 'privateMessage',
                        content: {
                                content: errorText
                        }
                };

                await db.events.add(errorMessage);
                await updateConversation(errorMessage);
        } finally {
                isGenerating.value = false;
                isTyping.value = false;
                typingMessage.value = '';
        }
};

/* 
// ÁúüÂÆûAIÂõûÂ§çÂáΩÊï∞ - ÂèñÊ∂àÊ≥®Èáä‰ª•ÊÅ¢Â§çÁúüÂÆûAIÂäüËÉΩ
const generateReply = async () => {
        if (isGenerating.value) return;
        
        isGenerating.value = true;
        
        try {
                // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                const lastUserMessage = displayedMessages.value
                        .filter(msg => msg.actorId === USER_ACTOR_ID)
                        .pop();
                
                if (!lastUserMessage) {
                        console.warn('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑Ê∂àÊÅØ');
                        return;
                }

                // Ëé∑ÂèñÂΩìÂâç‰∏ä‰∏ãÊñáÂØπÂ∫îÁöÑÁî®Êà∑‰∫∫Ê†ºID
                let effectiveUserId = USER_ACTOR_ID;
                if (currentUserPersona.value && currentUserPersona.value.id) {
                        effectiveUserId = currentUserPersona.value.id;
                        console.log('‰ΩøÁî®Áî®Êà∑‰∫∫Ê†º:', currentUserPersona.value.name, '(ID:', effectiveUserId, ')');
                } else {
                        console.log('‰ΩøÁî®ÈªòËÆ§Áî®Êà∑ID:', effectiveUserId);
                }

                // Ë∞ÉÁî®AIÊúçÂä°ÁîüÊàêÂõûÂ§ç
                const aiResult = await generateAIReply(
                        actorId.value, 
                        effectiveUserId, 
                        lastUserMessage.content.content
                );

                if (aiResult.success && aiResult.messages) {
                        // Â§ÑÁêÜAIËøîÂõûÁöÑÂ§öÊù°Ê∂àÊÅØÔºå‰∏∫ÊØèÊù°Ê∂àÊÅØÊ∑ªÂä†ÊâìÂ≠óÁâπÊïà
                        for (let i = 0; i < aiResult.messages.length; i++) {
                                const aiMessage = aiResult.messages[i];
                                
                                // ÂºÄÂßãÊâìÂ≠óÁä∂ÊÄÅ
                                isTyping.value = true;
                                
                                // ÊòæÁ§∫ÊãºÈü≥ÊâìÂ≠óÁâπÊïà
                                await simulatePinyinTyping(aiMessage.content);
                                
                                const messageEvent = {
                                        timestamp: Date.now(),
                                        actorId: actorId.value,
                                        contextId: actorId.value,
                                        type: 'privateMessage',
                                        content: {
                                                content: aiMessage.content,
                                                action: aiMessage.action
                                        }
                                };

                                await db.events.add(messageEvent);
                                await updateConversation(messageEvent);
                                
                                // Ê∂àÊÅØÈó¥‰øùÊåÅËæìÂÖ•Áä∂ÊÄÅÔºåÂè™Ê∏ÖÁ©∫ÂΩìÂâçÊâìÂ≠óÂÜÖÂÆπ
                                if (i < aiResult.messages.length - 1) {
                                        typingMessage.value = '';
                                        // ‰øùÊåÅisTyping‰∏∫trueÔºåÁ°Æ‰øùheaderÊåÅÁª≠ÊòæÁ§∫"Ê≠£Âú®ËæìÂÖ•‰∏≠"
                                        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                                }
                        }

                        // Â¶ÇÊûúÊúâÂÖ≥Á≥ªÂèòÂåñÔºåÊòæÁ§∫ÊèêÁ§∫
                        if (aiResult.relationship && aiResult.relationship.scoreChange !== 0) {
                                console.log(`Â•ΩÊÑüÂ∫¶ÂèòÂåñ: ${aiResult.relationship.scoreChange > 0 ? '+' : ''}${aiResult.relationship.scoreChange}`);
                        }

                        // Â¶ÇÊûú‰øùÂ≠ò‰∫ÜÊñ∞ËÆ∞ÂøÜÔºåÊòæÁ§∫ÊèêÁ§∫
                        if (aiResult.memory && aiResult.memory.shouldSave) {
                                console.log('AI‰øùÂ≠ò‰∫ÜÊñ∞ÁöÑËÆ∞ÂøÜ');
                        }
                } else {
                        // AIË∞ÉÁî®Â§±Ë¥•ÔºåÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                        isTyping.value = true;
                        await simulatePinyinTyping(aiResult.error || 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÂ§ç„ÄÇ');
                        
                        const errorMessage = {
                                timestamp: Date.now(),
                                actorId: actorId.value,
                                contextId: actorId.value,
                                type: 'privateMessage',
                                content: {
                                        content: aiResult.error || 'Êä±Ê≠âÔºåÊàëÁé∞Âú®Êó†Ê≥ïÂõûÂ§ç„ÄÇ'
                                }
                        };

                        await db.events.add(errorMessage);
                        await updateConversation(errorMessage);
                }
                
        } catch (error) {
                console.error('ÁîüÊàêÂõûÂ§çÂ§±Ë¥•:', error);
                
                // Ê∑ªÂä†ÈîôËØØÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
                isTyping.value = true;
                const errorText = `Êä±Ê≠âÔºåÂá∫Áé∞‰∫ÜÈîôËØØÔºö${error.message}`;
                await simulatePinyinTyping(errorText);
                
                const errorMessage = {
                        timestamp: Date.now(),
                        actorId: actorId.value,
                        contextId: actorId.value,
                        type: 'privateMessage',
                        content: {
                                content: errorText
                        }
                };

                await db.events.add(errorMessage);
                await updateConversation(errorMessage);
        } finally {
                isGenerating.value = false;
                isTyping.value = false;
                typingMessage.value = '';
        }
};
*/

// Ê®°ÊãüÊãºÈü≥ÊâìÂ≠óÁâπÊïà
const simulatePinyinTyping = async (fullMessage) => {
        isTyping.value = true;
        typingMessage.value = '';
        currentTypingIndex.value = 0;
        
        // Ëé∑ÂèñÂΩìÂâçÁöÑÊâìÂ≠óÈÄüÂ∫¶ÈÖçÁΩÆ
        const delayConfig = getTypingDelayConfig(personalSettings.value.typingSimulation.speed);
        
        // Â∞ÜÊ∂àÊÅØËΩ¨Êç¢‰∏∫Â≠óÁ¨¶Êï∞ÁªÑÔºåÊ≠£Á°ÆÂ§ÑÁêÜ‰∏≠ÊñáÂ≠óÁ¨¶
        const chars = Array.from(fullMessage);
        
        for (let i = 0; i < chars.length; i++) {
                const char = chars[i];
                
                // Â¶ÇÊûúÊòØ‰∏≠ÊñáÂ≠óÁ¨¶ÔºåÊ®°ÊãüÊãºÈü≥ËæìÂÖ•ËøáÁ®ã
                if (/[\u4e00-\u9fff]/.test(char)) {
                        // ÁîüÊàêËØ•Â≠óÁ¨¶ÁöÑÊ®°ÊãüÊãºÈü≥
                        const pinyinSteps = generatePinyinSteps(char);
                        
                        // ÊòæÁ§∫ÊãºÈü≥ËæìÂÖ•ËøáÁ®ã
                        for (const step of pinyinSteps) {
                                typingMessage.value = chars.slice(0, i).join('') + step;
                                currentTypingIndex.value = i;
                                
                                // ÊªöÂä®Âà∞Â∫ïÈÉ®Á°Æ‰øùÁî®Êà∑ÁúãÂà∞ÊâìÂ≠óÊïàÊûú
                                await nextTick();
                                scrollToBottom();
                                
                                // ‰ΩøÁî®ÈÖçÁΩÆÁöÑÊãºÈü≥Ê≠•È™§Âª∂Ëøü
                                await new Promise(resolve => setTimeout(resolve, delayConfig.pinyinStepDelay));
                        }
                } else {
                        // Èùû‰∏≠ÊñáÂ≠óÁ¨¶Áõ¥Êé•ÊòæÁ§∫
                        typingMessage.value = chars.slice(0, i + 1).join('');
                        currentTypingIndex.value = i;
                        
                        // ÊªöÂä®Âà∞Â∫ïÈÉ®Á°Æ‰øùÁî®Êà∑ÁúãÂà∞ÊâìÂ≠óÊïàÊûú
                        await nextTick();
                        scrollToBottom();
                        
                        // ‰ΩøÁî®ÈÖçÁΩÆÁöÑÂ≠óÁ¨¶Âª∂Ëøü
                        await new Promise(resolve => setTimeout(resolve, delayConfig.characterDelay));
                }
                
                // Âú®Á©∫Ê†ºÂíåÊ†áÁÇπÁ¨¶Âè∑ÂêéÊ∑ªÂä†È¢ùÂ§ñÂÅúÈ°ø
                if (/[\sÔºå„ÄÇÔºÅÔºüÔºõÔºö]/.test(char)) {
                        await new Promise(resolve => setTimeout(resolve, delayConfig.wordPauseDelay));
                }
        }
        
        // ÊâìÂ≠óÂÆåÊàêÂêé‰ΩøÁî®ÈÖçÁΩÆÁöÑÂè•Â≠êÂÅúÈ°øÊó∂Èó¥
        await new Promise(resolve => setTimeout(resolve, delayConfig.sentencePauseDelay));
        
        // ‰∏çÂú®ËøôÈáåÊ∏ÖÈô§ÊâìÂ≠óÁä∂ÊÄÅÔºåÁî±Â§ñÈÉ®Ë∞ÉÁî®ËÄÖÊéßÂà∂
};

// ÁîüÊàêÊ®°ÊãüÊãºÈü≥ËæìÂÖ•Ê≠•È™§Ôºà‰ΩøÁî®pinyin-proÂ∫ìÔºâ
const generatePinyinSteps = (chineseChar) => {
        try {
                // ‰ΩøÁî®pinyin-proËé∑ÂèñÊãºÈü≥ÔºåËÆæÁΩÆ‰∏∫‰∏çÂ∏¶Èü≥Ë∞É
                const pinyinResult = pinyin(chineseChar, { 
                        toneType: 'none', 
                        type: 'array' 
                });
                
                if (pinyinResult && pinyinResult.length > 0) {
                        const pinyinStr = pinyinResult[0];
                        
                        // ÁîüÊàêÊ∏êËøõÂºèÊãºÈü≥ËæìÂÖ•Ê≠•È™§
                        const steps = [];
                        for (let i = 1; i <= pinyinStr.length; i++) {
                                steps.push(pinyinStr.substring(0, i));
                        }
                        return steps;
                }
        } catch (error) {
                console.warn(`Ëé∑Âèñ "${chineseChar}" ÁöÑÊãºÈü≥Â§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï:`, error);
        }
        
        // Â¶ÇÊûúpinyin-proÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï
        return generateGenericPinyin(chineseChar);
};

// ÁîüÊàêÈÄöÁî®ÊãºÈü≥Ê≠•È™§Ôºà‰∏∫Êú™È¢ÑËÆæÁöÑÊ±âÂ≠óÔºâ
const generateGenericPinyin = (char) => {
        // Â∏∏ËßÅÊãºÈü≥ÂºÄÂ§¥Â≠óÊØç
        const initials = ['b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'z', 'c', 's', 'r', 'zh', 'ch', 'sh', 'w', 'y'];
        const finals = ['a', 'o', 'e', 'i', 'u', 'v', 'ai', 'ei', 'ao', 'ou', 'an', 'en', 'ang', 'eng', 'ong'];
        
        // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂêàÁêÜÁöÑÊãºÈü≥ÁªÑÂêà
        const initial = initials[Math.floor(Math.random() * initials.length)];
        const final = finals[Math.floor(Math.random() * finals.length)];
        
        // ÁîüÊàêÊ∏êËøõÂºèÊãºÈü≥ËæìÂÖ•
        const steps = [];
        const fullPinyin = initial + final;
        
        for (let i = 1; i <= fullPinyin.length; i++) {
                steps.push(fullPinyin.substring(0, i));
        }
        
        return steps;
};

// Êõ¥Êñ∞conversationË°®
const updateConversation = async (message) => {
        const conversation = {
                id: actorId.value,
                lastEventTimestamp: message.timestamp,
                lastEventContent: message.content,
                unreadCount: message.actorId === USER_ACTOR_ID ? 0 : 1, // Â¶ÇÊûúÊòØÁî®Êà∑ÂèëÈÄÅÂàôÈáçÁΩÆÊú™ËØªÊï∞
                summaryState: null
        };

        await db.conversations.put(conversation);
};

// ËøîÂõû‰∏ä‰∏ÄÈ°µ
const goBack = () => {
        // Êô∫ËÉΩËøîÂõûÔºö‰ºòÂÖàËøîÂõûÂà∞Ê∂àÊÅØÂàóË°®
        const referrer = document.referrer;
        const currentPath = router.currentRoute.value.path;
        
        // Â¶ÇÊûúÊúâÊµèËßàÂô®ÂéÜÂè≤ËÆ∞ÂΩï‰∏î‰∏çÊòØ‰ªéÂΩìÂâçÈ°µÈù¢Âà∑Êñ∞ÔºåÂàôËøîÂõû‰∏ä‰∏ÄÈ°µ
        if (window.history.length > 1 && !referrer.includes(currentPath)) {
                router.back();
        } else {
                // Âê¶ÂàôËøîÂõûÂà∞Ê∂àÊÅØÂàóË°®
                router.push('/chat/messages');
        }
};

// Ë∑≥ËΩ¨Âà∞profile
const goToProfile = () => {
        router.push(`/profile/${actorId.value}`);
};

// ÁîüÊàêÈ¶ñÂ≠óÊØçÂ§¥ÂÉèÔºàÂèÇËÄÉ MeView ÁöÑÈÄªËæëÔºâ
const getInitial = (name) => {
        if (!name) return 'U';
        return name.charAt(0).toUpperCase();
};

// Âà∑Êñ∞‰∏™‰∫∫ËÆæÁΩÆ
const refreshPersonalSettings = async () => {
        try {
                const settings = await getPersonalSettings();
                personalSettings.value = settings;
                console.log('ChatRoom: Refreshed personal settings:', settings);
        } catch (error) {
                console.error('ChatRoom: Failed to refresh personal settings:', error);
        }
};

// ÁõëÂê¨Ë°®ÊÉÖÂåÖÈù¢ÊùøÁä∂ÊÄÅÂèòÂåñ
watch(showStickerPanel, (newVal, oldVal) => {
        if (newVal !== oldVal) {
                nextTick(() => {
                        setTimeout(scrollToBottom, 150);
                });
        }
});

// ÁõëÂê¨‰∏™‰∫∫ËÆæÁΩÆÂèòÂåñÔºåÂÆûÊó∂Êõ¥Êñ∞
watch(() => personalSettings.value, async (newSettings) => {
        if (newSettings) {
                console.log('ChatRoom: Personal settings updated:', newSettings);
        }
}, { deep: true });

// ÂàùÂßãÂåñÈªòËÆ§Áä∂ÊÄÅ
onMounted(async () => {
        // Âä†ËΩΩ‰∏™‰∫∫ËÆæÁΩÆ
        try {
                const settings = await getPersonalSettings();
                personalSettings.value = settings;
                console.log('ChatRoom: Loaded personal settings:', settings);
        } catch (error) {
                console.error('ChatRoom: Failed to load personal settings:', error);
        }
        
        // Á°Æ‰øùÊúâÈªòËÆ§Áî®Êà∑‰∫∫Ê†º
        const defaultPersona = await getDefaultUserPersona();
        if (!defaultPersona) {
                // Â¶ÇÊûúÊ≤°ÊúâÈªòËÆ§‰∫∫Ê†ºÔºåÂàõÂª∫‰∏Ä‰∏™
                const defaultUserPersona = {
                        id: 'user_default',
                        name: 'User',
                        realName: '',
                        aliases: [],
                        gender: '',
                        birthday: '',
                        persona: '',
                        avatar: '',
                        groupIds: [],
                        isDefault: true,
                        type: 'user',
                        avatarLibrary: []
                };
                await db.actors.put(defaultUserPersona);
                console.log('ChatRoom: Created default user persona');
        }

        if (actor.value && !actor.value.status) {
                await db.actors.update(actorId.value, {
                        status: {
                                color: '#4CAF50',
                                text: 'Âú®Á∫ø'
                        }
                });
        }
        
        // Á≠âÂæÖÊ∂àÊÅØÂä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        await nextTick();
        
        // ÂàùÂßãÊòæÁ§∫ÊúÄÊñ∞ÁöÑ30Êù°Ê∂àÊÅØ
        messageOffset.value = 0;
        
        setTimeout(() => {
                scrollToBottom();
        }, 100);
        
        // Âä†ËΩΩË°®ÊÉÖÂåÖÊï∞ÊçÆ
        loadStickers();
        
        // Âä†ËΩΩÂπ∂Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè‰Ωú‰∏∫‰∏ªÈ¢ò
        if (actor.value) {
                try {
                        const bubbleStyle = await applyActorTheme(actor.value.id, isUsingUserBubbleTheme.value);
                        currentBubbleStyle.value = bubbleStyle;
                        
                        // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
                        const messagesContainerEl = document.querySelector('.messages-container');
                        if (messagesContainerEl && actor.value.chatBackground) {
                                messagesContainerEl.style.backgroundImage = `url('${actor.value.chatBackground}')`;
                                messagesContainerEl.style.backgroundSize = 'cover';
                                messagesContainerEl.style.backgroundPosition = 'center';
                                messagesContainerEl.style.backgroundRepeat = 'no-repeat';
                                messagesContainerEl.style.backgroundAttachment = 'fixed';
                        } else if (messagesContainerEl) {
                                // Ê∏ÖÈô§ËÉåÊôØÂõæ
                                messagesContainerEl.style.backgroundImage = 'none';
                        }
                } catch (error) {
                        console.error('Failed to load bubble style:', error);
                }
        }
        
        // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        const handleResize = () => {
                // Á°Æ‰øùÂÜÖÂÆπÈÄÇÂ∫îÊñ∞ÁöÑÁ™óÂè£Â§ßÂ∞è
                nextTick(() => scrollToBottom());
        };
        
        // ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÔºåÂΩìÁî®Êà∑ËøîÂõûÊó∂Âà∑Êñ∞ËÆæÁΩÆ
        const handleVisibilityChange = () => {
                if (!document.hidden) {
                        // È°µÈù¢Âèò‰∏∫ÂèØËßÅÊó∂Âà∑Êñ∞ËÆæÁΩÆ
                        refreshPersonalSettings();
                }
        };
        
        window.addEventListener('resize', handleResize);
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
        return () => {
                window.removeEventListener('resize', handleResize);
                document.removeEventListener('visibilitychange', handleVisibilityChange);
        };
});

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂ÊÅ¢Â§çÂéüÂßã‰∏ªÈ¢ò
onUnmounted(() => {
        restoreOriginalTheme();
});
</script>

<style scoped>
.header-action-button {
        background: none;
        border: none;
        color: var(--accent-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.2s;
}

.header-action-button svg {
        width: 24px;
        height: 24px;
}

.status-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
}

.status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        box-shadow: 0 0 6px var(--status-color, rgba(76, 175, 80, 0.6));
        animation: pulse 2s infinite;
}

@keyframes pulse {
        0% {
                box-shadow: 0 0 6px var(--status-color, rgba(76, 175, 80, 0.6));
        }
        50% {
                box-shadow: 0 0 10px var(--status-color, rgba(76, 175, 80, 0.8));
        }
        100% {
                box-shadow: 0 0 6px var(--status-color, rgba(76, 175, 80, 0.6));
        }
}

.status-text {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 400;
}

.chat-content {
        flex-grow: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 0;
}

.messages-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 20px;
        padding-top: calc(var(--header-height) + 15px);
        display: flex;
        flex-direction: column;
        gap: 15px;
        transition: padding-bottom 0.3s ease;
}

.loading-indicator {
        text-align: center;
        padding: 10px;
        color: var(--text-secondary);
        font-size: 14px;
}

.message-item {
        display: flex;
        gap: 10px;
}

.message-item.own-message {
        flex-direction: row-reverse;
}

.message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--bg-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
}

.message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
}

.avatar-initial {
        color: var(--accent-primary);
        font-weight: 600;
        font-size: 14px;
}

.message-content {
        max-width: 70%;
        display: flex;
        flex-direction: column;
        gap: 4px;
}

.own-message .message-content {
        align-items: flex-end;
}

.message-bubble {
        background-color: var(--char-bubble-bg, var(--bg-card));
        color: var(--char-bubble-text, var(--text-primary));
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
}

.own-message .message-bubble {
        background-color: var(--user-bubble-bg, var(--accent-primary));
        color: var(--user-bubble-text, var(--text-inverse));
}

.message-bubble p {
        margin: 0;
        line-height: 1.4;
}

.message-action {
        margin-top: 6px;
        font-style: italic;
        opacity: 0.8;
        font-size: 0.9em;
}

/* HeaderÊ†áÈ¢òÂä®ÁîªÊ†∑Âºè */
.typing-title {
        display: flex;
        align-items: center;
        gap: 2px;
}

.breathing-dots {
        animation: breathing 2s ease-in-out infinite;
        color: var(--accent-primary);
}

@keyframes breathing {
        0%, 100% {
                opacity: 0.3;
                transform: scale(0.9);
        }
        50% {
                opacity: 1;
                transform: scale(1.1);
        }
}


/* ÊâìÂ≠óÁâπÊïàÊ†∑Âºè */
.typing-bubble {
        background-color: var(--char-bubble-bg);
        border: 1px solid var(--accent-border);
        position: relative;
}



.message-time {
        font-size: 11px;
        color: var(--text-secondary);
        padding: 0 8px;
}

.input-area {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--bg-primary);
        border-top: 1px solid var(--border-color);
        padding-top: 5px;
        padding-bottom: max(var(--safe-bottom), 15px);
        padding-left: 15px;
        padding-right: 15px;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        z-index: 100;
}

/* Á°Æ‰øùÂú®ÈîÆÁõòÂºπÂá∫Êó∂input-areaËÉΩÂ§üÊ≠£Á°ÆÊòæÁ§∫ */
.input-area.keyboard-visible {
        z-index: 100;
}

.input-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
}

.function-buttons {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 0 5px;
}

.function-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        background-color: var(--bg-card);
        color: var(--accent-darker);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
}

.function-btn:hover {
        background-color: var(--accent-primary);
        color: var(--accent-text);
        transform: scale(1.05);
}

/* ÂäüËÉΩÊåâÈíÆÊøÄÊ¥ªÁä∂ÊÄÅ */
.function-btn.active {
        background-color: var(--accent-primary);
        color: var(--text-inverse);
        transform: scale(0.95);
}

.input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;;
}

.message-input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 22px; /* ÂúÜÂΩ¢ËæìÂÖ•Ê°Ü */
        background-color: var(--bg-card);
        color: var(--text-primary);
        font-size: 16px;
        resize: none;
        outline: none;
        overflow-y: auto;
        line-height: 1.4;
        max-height: 20px;
}

.message-input:focus {
        border-color: var(--accent-primary);
}

.action-button {
        width: 44px;  /* ÂúÜÂΩ¢ÊåâÈíÆÔºåÂÆΩÈ´òÁõ∏Á≠â */
        height: 44px;
        border: none;
        border-radius: 50%; /* ÂúÜÂΩ¢ÊåâÈíÆ */
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
}

.generate-btn {
        background-color: var(--bg-card);
        color: var(--accent-darker);
        border: 1px solid var(--accent-border);
}

.generate-btn:hover:not(:disabled) {
        background-color: var(--bg-secondary);
        transform: scale(1.05);
}

.send-btn {
        background-color: var(--accent-primary);
        color: var(--accent-text);
}

.send-btn:hover:not(:disabled) {
        background-color: var(--accent-darker);
        transform: scale(1.05);
}

.action-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
}

.loading-state {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
}

/* ÈöêËóèÊªöÂä®Êù° */
.messages-container::-webkit-scrollbar {
        width: 0;
        background: transparent;
}

.message-input::-webkit-scrollbar {
        width: 0;
        background: transparent;
}

/* Ë°®ÊÉÖÂåÖÈù¢ÊùøÊ†∑Âºè */
.sticker-panel {
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        padding: 15px;
        overflow-y: auto;
        position: relative;
        margin: 15px;
        z-index: 101; /* Á°Æ‰øùÂú®ËæìÂÖ•Âå∫Âüü‰πã‰∏ä */
        border-radius: 22px;
        height: 1000px;
}

.sticker-panel ::-webkit-scrollbar {
        display: none;
}

.sticker-panel {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
}

/* Ë∞ÉÊï¥Âä®Áîª‰ΩøÂÖ∂Êõ¥ÊµÅÁïÖ */
.sticker-panel-enter-active,
.sticker-panel-leave-active {
        transition: transform 0.3s ease, opacity 0.3s ease;
}
.empty-stickers {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--text-secondary);
        text-align: center;
}

.add-stickers-link {
        color: var(--accent-primary);
        text-decoration: none;
        font-weight: 500;
}

.add-stickers-link:hover {
        text-decoration: underline;
}

.sticker-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        padding: 5px 0;
}

.sticker-item {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s ease;
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
}

.sticker-item:hover {
        transform: scale(1.1);
}

.sticker-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
}

/* Ë°®ÊÉÖÂåÖÊ∂àÊÅØÊ†∑Âºè */
.sticker-message {
        display: inline-block;
}

.sticker-image {
        max-width: 120px;
        max-height: 120px;
        border-radius: 8px;
}

/* ÂõæÁâáÊ∂àÊÅØÊ†∑Âºè */
.image-message {
        display: inline-block;
        margin: 4px 0;
}

.text-image-placeholder {
        background-color: var(--bg-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        max-width: 200px;
        min-width: 150px;
        color: var(--text-secondary);
}

.text-image-icon {
        font-size: 32px;
        margin-bottom: 8px;
}

.text-image-description {
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
}

.real-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.2s;
}

.real-image:hover {
        transform: scale(1.02);
}

/* ÊîØ‰ªòÊ∂àÊÅØÊ†∑Âºè */
.payment-message {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-darker));
        color: var(--text-inverse);
        padding: 16px;
        border-radius: 16px;
        min-width: 180px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.payment-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 8px;
}

.payment-icon {
        font-size: 18px;
}

.payment-type {
        font-weight: 600;
        font-size: 14px;
}

.payment-amount {
        font-size: 24px;
        font-weight: 700;
        margin: 8px 0;
}

.payment-product {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
}

.payment-note {
        font-size: 12px;
        opacity: 0.8;
        font-style: italic;
}

/* Èù¢ÊùøÂàáÊç¢Âä®Áîª */
.sticker-panel-enter-active,
.sticker-panel-leave-active {
        transition: all 0.2s ease;
}

.sticker-panel-enter-from,
.sticker-panel-leave-to {
        height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
}

.sticker-panel-enter-to,
.sticker-panel-leave-from {
        opacity: 1;
        transform: translateY(0);
}

/* ÊâìÂ≠óÊåáÁ§∫Âô® */
.typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 0;
}

.typing-dot {
        width: 6px;
        height: 6px;
        background-color: var(--text-secondary);
        border-radius: 50%;
        animation: typing-pulse 1.4s ease-in-out infinite;
}

.typing-dot:nth-child(1) {
        animation-delay: 0s;
}

.typing-dot:nth-child(2) {
        animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
        animation-delay: 0.4s;
}

@keyframes typing-pulse {
        0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(1);
        }
        30% {
                opacity: 1;
                transform: scale(1.2);
        }
}

/* ËæìÂÖ•Âå∫ÂüüË¢´È°∂Ëµ∑ÁöÑÊïàÊûú */
.input-area {
        position: relative;
}

.input-container {
        background: var(--bg-primary);
        border-top: 1px solid var(--border-light);
}
</style>